/* io_syscalls.c */
#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/stat.h>
#include <dirent.h>
#include <string.h>
#include <errno.h>

int main(int argc, char *argv[]) {
    const char *f = (argc>1)?argv[1]:"io_demo.txt";
    int fd = open(f, O_RDWR | O_CREAT, 0644);
    if(fd < 0) { perror("open"); return 1; }

    // fcntl: get and set flags (example: non-blocking)
    int flags = fcntl(fd, F_GETFL);
    if(flags == -1) perror("fcntl GETFL");
    else {
        printf("Initial flags: %d\n", flags);
        // set close-on-exec as example
        if(fcntl(fd, F_SETFD, FD_CLOEXEC) == -1) perror("fcntl SETFD");
        else printf("Set FD_CLOEXEC on fd\n");
    }

    // write some text
    const char *t = "I/O syscalls demo\n";
    write(fd, t, strlen(t));

    // lseek: move and then write
    off_t off = lseek(fd, 0, SEEK_SET);
    if(off == (off_t)-1) perror("lseek");
    else {
        write(fd, "START: ", 7);
        printf("Wrote at start using lseek\n");
    }

    // stat
    struct stat st;
    if(stat(f, &st) == 0) {
        printf("File size: %lld bytes\n", (long long)st.st_size);
        printf("Permissions: %o\n", st.st_mode & 0777);
    } else perror("stat");

    close(fd);

    // opendir / readdir
    const char *dirpath = ".";
    DIR *d = opendir(dirpath);
    if(!d){ perror("opendir"); return 1; }
    printf("\nDirectory listing of %s:\n", dirpath);
    struct dirent *entry;
    while((entry = readdir(d)) != NULL) {
        printf("  %s\n", entry->d_name);
    }
    closedir(d);
    return 0;
}
